/*
Deployment script for vms.db

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "vms.db"
:setvar DefaultFilePrefix "vms.db"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [master];


GO

IF (DB_ID(N'$(DatabaseName)') IS NOT NULL) 
BEGIN
    ALTER DATABASE [$(DatabaseName)]
    SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE [$(DatabaseName)];
END

GO
PRINT N'Creating $(DatabaseName)...'
GO
CREATE DATABASE [$(DatabaseName)] COLLATE SQL_Latin1_General_CP1_CI_AS
GO
USE [$(DatabaseName)];


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS OFF,
                ANSI_PADDING OFF,
                ANSI_WARNINGS OFF,
                ARITHABORT OFF,
                CONCAT_NULL_YIELDS_NULL OFF,
                NUMERIC_ROUNDABORT OFF,
                QUOTED_IDENTIFIER OFF,
                ANSI_NULL_DEFAULT OFF,
                CURSOR_DEFAULT GLOBAL,
                RECOVERY FULL,
                CURSOR_CLOSE_ON_COMMIT OFF,
                AUTO_CREATE_STATISTICS ON,
                AUTO_SHRINK OFF,
                AUTO_UPDATE_STATISTICS ON,
                RECURSIVE_TRIGGERS OFF 
            WITH ROLLBACK IMMEDIATE;
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CLOSE OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET READ_COMMITTED_SNAPSHOT OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_UPDATE_STATISTICS_ASYNC OFF,
                PAGE_VERIFY CHECKSUM,
                DATE_CORRELATION_OPTIMIZATION OFF,
                DISABLE_BROKER,
                PARAMETERIZATION SIMPLE,
                SUPPLEMENTAL_LOGGING OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET TRUSTWORTHY OFF,
        DB_CHAINING OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET HONOR_BROKER_PRIORITY OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 60 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET FILESTREAM(NON_TRANSACTED_ACCESS = OFF),
                CONTAINMENT = NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CREATE_STATISTICS ON(INCREMENTAL = OFF),
                MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT = OFF,
                DELAYED_DURABILITY = DISABLED 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (QUERY_CAPTURE_MODE = ALL, DATA_FLUSH_INTERVAL_SECONDS = 900, INTERVAL_LENGTH_MINUTES = 60, MAX_PLANS_PER_QUERY = 200, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 30), MAX_STORAGE_SIZE_MB = 100) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE = OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE SCOPED CONFIGURATION SET MAXDOP = 0;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET MAXDOP = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET LEGACY_CARDINALITY_ESTIMATION = OFF;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET LEGACY_CARDINALITY_ESTIMATION = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET PARAMETER_SNIFFING = ON;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET PARAMETER_SNIFFING = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET QUERY_OPTIMIZER_HOTFIXES = OFF;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET QUERY_OPTIMIZER_HOTFIXES = PRIMARY;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET TEMPORAL_HISTORY_RETENTION ON 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF fulltextserviceproperty(N'IsFulltextInstalled') = 1
    EXECUTE sp_fulltext_database 'enable';


GO
PRINT N'Creating [BRACITS\Administrator]...';


GO
CREATE LOGIN [BRACITS\Administrator]
    FROM WINDOWS WITH DEFAULT_LANGUAGE = [us_english];


GO
PRINT N'Creating [BRACITS\samnoon.mohebbo]...';


GO
CREATE LOGIN [BRACITS\samnoon.mohebbo]
    FROM WINDOWS WITH DEFAULT_LANGUAGE = [us_english];


GO
PRINT N'Creating [BRACITS\Administrator]...';


GO
CREATE USER [BRACITS\Administrator] FOR LOGIN [BRACITS\Administrator];


GO
PRINT N'Creating [BRACITS\samnoon.mohebbo]...';


GO
CREATE USER [BRACITS\samnoon.mohebbo] FOR LOGIN [BRACITS\samnoon.mohebbo];


GO
PRINT N'Creating [acc]...';


GO
CREATE SCHEMA [acc]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [dbo].[Orders]...';


GO
CREATE TABLE [dbo].[Orders] (
    [PurchaseOrderId] INT             NOT NULL,
    [OrderDate]       DATETIME        NOT NULL,
    [OrganizationId]  INT             NOT NULL,
    [Amount]          DECIMAL (18, 2) NOT NULL,
    [DeliveryDate]    DATETIME        NULL,
    [Iteams]          INT             NOT NULL,
    [VendorId]        INT             NULL,
    [VAT]             DECIMAL (18, 2) NOT NULL,
    [Discount]        DECIMAL (18, 2) NOT NULL,
    [IsComplete]      BIT             NOT NULL,
    [CreatedBy]       INT             NULL,
    [CreatedTime]     DATETIME        NULL,
    CONSTRAINT [PK_Orders_1] PRIMARY KEY CLUSTERED ([PurchaseOrderId] ASC)
);


GO
PRINT N'Creating [dbo].[Products]...';


GO
CREATE TABLE [dbo].[Products] (
    [ProductId]         INT             IDENTITY (1, 1) NOT NULL,
    [Name]              NVARCHAR (50)   NOT NULL,
    [Code]              NVARCHAR (50)   NULL,
    [HSCode]            NVARCHAR (50)   NULL,
    [ProductGroupId]    INT             NOT NULL,
    [Amount]            DECIMAL (18, 2) NOT NULL,
    [MeasurementUnitId] INT             NOT NULL,
    [EffectiveFrom]     DATETIME        NOT NULL,
    [EffectiveTo]       DATETIME        NULL,
    [IsActive]          BIT             NOT NULL,
    [CreatedBy]         INT             NULL,
    [CreatedTime]       DATETIME        NULL,
    CONSTRAINT [PK_Products] PRIMARY KEY CLUSTERED ([ProductId] ASC)
);


GO
PRINT N'Creating [dbo].[ProductGroups]...';


GO
CREATE TABLE [dbo].[ProductGroups] (
    [ProductGroupId] INT           IDENTITY (1, 1) NOT NULL,
    [Name]           NVARCHAR (50) NOT NULL,
    [ParentGroupId]  INT           NULL,
    [Node]           NVARCHAR (50) NULL,
    [IsActive]       BIT           NOT NULL,
    [CreatedBy]      INT           NULL,
    [CreatedTime]    DATETIME      NULL,
    CONSTRAINT [PK_ProductGroups] PRIMARY KEY CLUSTERED ([ProductGroupId] ASC)
);


GO
PRINT N'Creating [dbo].[MeasurementUnits]...';


GO
CREATE TABLE [dbo].[MeasurementUnits] (
    [MeasurementUnitId] INT           IDENTITY (1, 1) NOT NULL,
    [Name]              NVARCHAR (50) NOT NULL,
    [OrganizationId]    INT           NOT NULL,
    [IsActive]          BIT           NOT NULL,
    [CreatedBy]         INT           NULL,
    [CreatedTime]       DATETIME      NULL,
    CONSTRAINT [PK_MeasurementUnits] PRIMARY KEY CLUSTERED ([MeasurementUnitId] ASC)
);


GO
PRINT N'Creating [dbo].[ExportType]...';


GO
CREATE TABLE [dbo].[ExportType] (
    [ExportTypeId]   INT           IDENTITY (1, 1) NOT NULL,
    [ExportTypeName] NVARCHAR (50) NOT NULL,
    [CreatedBy]      INT           NULL,
    [CreatedTime]    DATETIME      NULL,
    CONSTRAINT [PK_ExportType] PRIMARY KEY CLUSTERED ([ExportTypeId] ASC)
);


GO
PRINT N'Creating [dbo].[SalesType]...';


GO
CREATE TABLE [dbo].[SalesType] (
    [SalesTypeId]   INT            IDENTITY (1, 1) NOT NULL,
    [SalesTypeName] NVARCHAR (50)  NOT NULL,
    [Description]   NVARCHAR (200) NULL,
    [CreatedBy]     INT            NULL,
    [CreatedTime]   DATETIME       NULL,
    CONSTRAINT [PK_SalesType] PRIMARY KEY CLUSTERED ([SalesTypeId] ASC)
);


GO
PRINT N'Creating [dbo].[Sales]...';


GO
CREATE TABLE [dbo].[Sales] (
    [SalesId]              INT             IDENTITY (1, 1) NOT NULL,
    [CustomerId]           INT             NULL,
    [CustomerContactNo]    VARCHAR (20)    NULL,
    [WorkOrderNo]          NVARCHAR (50)   NULL,
    [InvoiceNo]            NVARCHAR (50)   NOT NULL,
    [SalesDate]            DATETIME        NOT NULL,
    [VAT]                  DECIMAL (18, 2) NOT NULL,
    [OrganizationId]       INT             NOT NULL,
    [Amount]               DECIMAL (18, 2) NOT NULL,
    [ExpectedDeleveryDate] DATETIME        NULL,
    [DeliveryDate]         DATETIME        NULL,
    [ShippingAddress]      NVARCHAR (200)  NULL,
    [CountryId]            INT             NULL,
    [SalesTypeId]          INT             NOT NULL,
    [Iteams]               INT             NOT NULL,
    [Discount]             DECIMAL (18, 2) NOT NULL,
    [IsComplete]           BIT             NOT NULL,
    [CreatedBy]            INT             NULL,
    [CreatedTime]          DATETIME        NULL,
    [RemainingAmount]      DECIMAL (18, 2) NOT NULL,
    [ExportTypeId]         INT             NULL,
    CONSTRAINT [PK_Sales] PRIMARY KEY CLUSTERED ([SalesId] ASC)
);


GO
PRINT N'Creating [dbo].[SalesDetails]...';


GO
CREATE TABLE [dbo].[SalesDetails] (
    [SalesDetailId]     INT             IDENTITY (1, 1) NOT NULL,
    [ProductId]         INT             NOT NULL,
    [SalesId]           INT             NOT NULL,
    [Iteams]            INT             NOT NULL,
    [Amount]            DECIMAL (18, 2) NOT NULL,
    [VAT]               DECIMAL (18, 2) NOT NULL,
    [MeasurementUnitId] INT             NOT NULL,
    [CreatedBy]         INT             NULL,
    [CreatedTime]       DATETIME        NULL,
    CONSTRAINT [PK_SalesDetails] PRIMARY KEY CLUSTERED ([SalesDetailId] ASC)
);


GO
PRINT N'Creating [dbo].[Roles]...';


GO
CREATE TABLE [dbo].[Roles] (
    [RoleId]            INT           IDENTITY (1, 1) NOT NULL,
    [RoleName]          NVARCHAR (64) NOT NULL,
    [RoleDefaultPageId] INT           NOT NULL,
    [IsActive]          BIT           NOT NULL,
    [CreatedBy]         INT           NULL,
    [CreatedTime]       DATETIME      NULL,
    CONSTRAINT [PK_Roles] PRIMARY KEY CLUSTERED ([RoleId] ASC)
);


GO
PRINT N'Creating [dbo].[RoleRights]...';


GO
CREATE TABLE [dbo].[RoleRights] (
    [RoleRightId] INT      IDENTITY (1, 1) NOT NULL,
    [RoleId]      INT      NOT NULL,
    [RightId]     INT      NOT NULL,
    [CreatedBy]   INT      NULL,
    [CreatedTime] DATETIME NULL,
    CONSTRAINT [PK_RoleFeatures] PRIMARY KEY CLUSTERED ([RoleRightId] ASC)
);


GO
PRINT N'Creating [dbo].[Rights]...';


GO
CREATE TABLE [dbo].[Rights] (
    [RightId]     INT            IDENTITY (1, 1) NOT NULL,
    [RightName]   NVARCHAR (64)  NOT NULL,
    [Description] NVARCHAR (128) NULL,
    [IsActive]    BIT            NOT NULL,
    [CreatedBy]   INT            NULL,
    [CreatedTime] DATETIME       NULL,
    CONSTRAINT [PK_Rights] PRIMARY KEY CLUSTERED ([RightId] ASC)
);


GO
PRINT N'Creating [dbo].[Users]...';


GO
CREATE TABLE [dbo].[Users] (
    [UserId]        INT           IDENTITY (1, 1) NOT NULL,
    [UserName]      NVARCHAR (64) NOT NULL,
    [EmailAddress]  NVARCHAR (64) NULL,
    [Password]      NVARCHAR (64) NULL,
    [UserTypeId]    INT           NOT NULL,
    [RoleId]        INT           NOT NULL,
    [Mobile]        NVARCHAR (50) NULL,
    [IsActive]      BIT           NOT NULL,
    [LastLoginTime] DATETIME      NULL,
    [CreatedBy]     INT           NULL,
    [CreatedTime]   DATETIME      NULL,
    CONSTRAINT [PK_UserProfiles] PRIMARY KEY CLUSTERED ([UserId] ASC)
);


GO
PRINT N'Creating [dbo].[Vendor]...';


GO
CREATE TABLE [dbo].[Vendor] (
    [VendorId]    INT            IDENTITY (1, 1) NOT NULL,
    [Name]        NVARCHAR (200) NOT NULL,
    [Address]     NVARCHAR (500) NOT NULL,
    [ContactNo]   VARCHAR (20)   NULL,
    [CreatedBy]   INT            NULL,
    [CreatedTime] DATETIME       NULL,
    CONSTRAINT [PK_Vendor] PRIMARY KEY CLUSTERED ([VendorId] ASC)
);


GO
PRINT N'Creating [dbo].[TransactionLocalizationType]...';


GO
CREATE TABLE [dbo].[TransactionLocalizationType] (
    [TransactionLocalizationTypeId]     INT           IDENTITY (1, 1) NOT NULL,
    [TransactionLocalizationTypeName]   NVARCHAR (50) NOT NULL,
    [TransactionLocalizationTypeNameBn] NVARCHAR (50) NOT NULL,
    [CreatedBy]                         INT           NULL,
    [CreatedTime]                       DATETIME      NULL,
    CONSTRAINT [PK_TransactionLocalizationType] PRIMARY KEY CLUSTERED ([TransactionLocalizationTypeId] ASC)
);


GO
PRINT N'Creating [dbo].[PurchaseDetails]...';


GO
CREATE TABLE [dbo].[PurchaseDetails] (
    [PurchaseDetailId]  INT             IDENTITY (1, 1) NOT NULL,
    [ProductId]         INT             NOT NULL,
    [PurchaseId]        INT             NULL,
    [Iteams]            INT             NOT NULL,
    [Amount]            DECIMAL (18, 2) NOT NULL,
    [MeasurementUnitId] INT             NOT NULL,
    [CreatedBy]         INT             NULL,
    [CreatedTime]       DATETIME        NULL,
    CONSTRAINT [PK_PurchaseDetails] PRIMARY KEY CLUSTERED ([PurchaseDetailId] ASC)
);


GO
PRINT N'Creating [dbo].[TransectionTypes]...';


GO
CREATE TABLE [dbo].[TransectionTypes] (
    [TransectionTypeId] INT           IDENTITY (1, 1) NOT NULL,
    [Name]              NVARCHAR (50) NULL,
    [CreatedBy]         INT           NULL,
    [CreatedTime]       DATETIME      NULL,
    CONSTRAINT [PK_TransectionTypes] PRIMARY KEY CLUSTERED ([TransectionTypeId] ASC)
);


GO
PRINT N'Creating [dbo].[Purchase]...';


GO
CREATE TABLE [dbo].[Purchase] (
    [PurchaseId]           INT             IDENTITY (1, 1) NOT NULL,
    [Date]                 DATETIME        NOT NULL,
    [OrganizationId]       INT             NOT NULL,
    [Amount]               DECIMAL (18, 2) NOT NULL,
    [ExpectedDeleveryDate] DATETIME        NULL,
    [DeliveryDate]         DATETIME        NULL,
    [Iteams]               INT             NOT NULL,
    [VendorId]             INT             NULL,
    [VAT]                  DECIMAL (18, 2) NULL,
    [Discount]             DECIMAL (18, 2) NOT NULL,
    [IsComplete]           BIT             NOT NULL,
    [CreatedBy]            INT             NULL,
    [CreatedTime]          DATETIME        NULL,
    CONSTRAINT [PK_Purchase] PRIMARY KEY CLUSTERED ([PurchaseId] ASC)
);


GO
PRINT N'Creating [dbo].[Customer]...';


GO
CREATE TABLE [dbo].[Customer] (
    [CustomerId]  INT            IDENTITY (1, 1) NOT NULL,
    [Name]        NVARCHAR (200) NULL,
    [Address]     NVARCHAR (200) NULL,
    [CreatedBy]   INT            NULL,
    [CreatedTime] DATETIME       NULL,
    CONSTRAINT [PK_Customer] PRIMARY KEY CLUSTERED ([CustomerId] ASC)
);


GO
PRINT N'Creating [dbo].[Organizations]...';


GO
CREATE TABLE [dbo].[Organizations] (
    [OrganizationId]       INT           IDENTITY (1, 1) NOT NULL,
    [Name]                 NVARCHAR (50) NOT NULL,
    [ParentOrganizationId] INT           NULL,
    [Code]                 NVARCHAR (50) NULL,
    [VATRegNo]             NVARCHAR (50) NULL,
    [BIN]                  NVARCHAR (50) NULL,
    [CertificateNo]        NVARCHAR (50) NULL,
    [CountryId]            INT           NOT NULL,
    [CityId]               INT           NOT NULL,
    [IsActive]             BIT           NOT NULL,
    [EnlistedNo]           INT           NULL,
    [PostalCode]           INT           NULL,
    [CreatedBy]            INT           NULL,
    [CreatedTime]          DATETIME      NULL,
    CONSTRAINT [PK_Organizations] PRIMARY KEY CLUSTERED ([OrganizationId] ASC)
);


GO
PRINT N'Creating [dbo].[UserTypes]...';


GO
CREATE TABLE [dbo].[UserTypes] (
    [UserTypeId]    INT           IDENTITY (1, 1) NOT NULL,
    [UserTypeName]  NVARCHAR (50) NOT NULL,
    [IsActive]      BIT           NOT NULL,
    [EffectiveFrom] DATETIME      NOT NULL,
    [EffectiveTo]   DATETIME      NULL,
    [CreatedBy]     INT           NULL,
    [CreatedTime]   DATETIME      NULL,
    CONSTRAINT [PK_UserTypes] PRIMARY KEY CLUSTERED ([UserTypeId] ASC)
);


GO
PRINT N'Creating [dbo].[PurchaseTypes]...';


GO
CREATE TABLE [dbo].[PurchaseTypes] (
    [PurchaseTypeId] INT           IDENTITY (1, 1) NOT NULL,
    [Name]           NVARCHAR (50) NOT NULL,
    [CreatedBy]      INT           NULL,
    [CreatedTime]    DATETIME      NULL,
    CONSTRAINT [PK_PurchaseType] PRIMARY KEY CLUSTERED ([PurchaseTypeId] ASC)
);


GO
PRINT N'Creating [dbo].[ProductVATTypes]...';


GO
CREATE TABLE [dbo].[ProductVATTypes] (
    [ProductVATTypeId]              INT           IDENTITY (1, 1) NOT NULL,
    [Name]                          NVARCHAR (50) NULL,
    [DisplayName]                   NVARCHAR (50) NULL,
    [EffectiveFrom]                 NVARCHAR (50) NOT NULL,
    [EffectiveTo]                   NVARCHAR (50) NULL,
    [TransactionTypeId]             INT           NOT NULL,
    [TransactionLocalizationTypeId] INT           NULL,
    [IsActive]                      BIT           NULL,
    [CreatedBy]                     INT           NULL,
    [CreatedTime]                   DATETIME      NULL,
    CONSTRAINT [PK_ProductVATType] PRIMARY KEY CLUSTERED ([ProductVATTypeId] ASC)
);


GO
PRINT N'Creating [dbo].[OrderReceives]...';


GO
CREATE TABLE [dbo].[OrderReceives] (
    [OrderReceiveId]        INT             NOT NULL,
    [PurchaseOrderDetailID] INT             NULL,
    [ProductId]             INT             NOT NULL,
    [Quantity]              DECIMAL (18, 2) NOT NULL,
    [Amount]                DECIMAL (18, 2) NOT NULL,
    [TotalAmount]           DECIMAL (18, 2) NULL,
    [VAT]                   DECIMAL (18, 2) NULL,
    [CreatedBy]             INT             NULL,
    [CreatedTime]           DATETIME        NULL,
    CONSTRAINT [PK_OrderReceives_1] PRIMARY KEY CLUSTERED ([OrderReceiveId] ASC)
);


GO
PRINT N'Creating [acc].[COAGroups]...';


GO
CREATE TABLE [acc].[COAGroups] (
    [COAGroupId]    INT           IDENTITY (1, 1) NOT NULL,
    [Name]          NVARCHAR (50) NULL,
    [ParentGroupId] INT           NULL,
    [Node]          NVARCHAR (50) NULL,
    [IsActive]      BIT           NULL,
    [CreatedBy]     INT           NULL,
    [CreatedTime]   DATETIME      NULL,
    CONSTRAINT [PK_COAGroups] PRIMARY KEY CLUSTERED ([COAGroupId] ASC)
);


GO
PRINT N'Creating [dbo].[FK_Products_MeasurementUnits]...';


GO
ALTER TABLE [dbo].[Products]
    ADD CONSTRAINT [FK_Products_MeasurementUnits] FOREIGN KEY ([MeasurementUnitId]) REFERENCES [dbo].[MeasurementUnits] ([MeasurementUnitId]);


GO
PRINT N'Creating [dbo].[FK_Products_ProductGroups]...';


GO
ALTER TABLE [dbo].[Products]
    ADD CONSTRAINT [FK_Products_ProductGroups] FOREIGN KEY ([ProductGroupId]) REFERENCES [dbo].[ProductGroups] ([ProductGroupId]);


GO
PRINT N'Creating [dbo].[FK_Sales_Customer]...';


GO
ALTER TABLE [dbo].[Sales]
    ADD CONSTRAINT [FK_Sales_Customer] FOREIGN KEY ([CustomerId]) REFERENCES [dbo].[Customer] ([CustomerId]);


GO
PRINT N'Creating [dbo].[FK_Sales_ExportType]...';


GO
ALTER TABLE [dbo].[Sales]
    ADD CONSTRAINT [FK_Sales_ExportType] FOREIGN KEY ([ExportTypeId]) REFERENCES [dbo].[ExportType] ([ExportTypeId]);


GO
PRINT N'Creating [dbo].[FK_Sales_Organizations]...';


GO
ALTER TABLE [dbo].[Sales]
    ADD CONSTRAINT [FK_Sales_Organizations] FOREIGN KEY ([OrganizationId]) REFERENCES [dbo].[Organizations] ([OrganizationId]);


GO
PRINT N'Creating [dbo].[FK_Sales_SalesType]...';


GO
ALTER TABLE [dbo].[Sales]
    ADD CONSTRAINT [FK_Sales_SalesType] FOREIGN KEY ([SalesTypeId]) REFERENCES [dbo].[SalesType] ([SalesTypeId]);


GO
PRINT N'Creating [dbo].[FK_SalesDetails_MeasurementUnits]...';


GO
ALTER TABLE [dbo].[SalesDetails]
    ADD CONSTRAINT [FK_SalesDetails_MeasurementUnits] FOREIGN KEY ([MeasurementUnitId]) REFERENCES [dbo].[MeasurementUnits] ([MeasurementUnitId]);


GO
PRINT N'Creating [dbo].[FK_SalesDetails_Products]...';


GO
ALTER TABLE [dbo].[SalesDetails]
    ADD CONSTRAINT [FK_SalesDetails_Products] FOREIGN KEY ([ProductId]) REFERENCES [dbo].[Products] ([ProductId]);


GO
PRINT N'Creating [dbo].[FK_SalesDetails_Sales]...';


GO
ALTER TABLE [dbo].[SalesDetails]
    ADD CONSTRAINT [FK_SalesDetails_Sales] FOREIGN KEY ([SalesId]) REFERENCES [dbo].[Sales] ([SalesId]);


GO
PRINT N'Creating [dbo].[FK_dbo_RoleFeatures_dbo_Roles_RoleId]...';


GO
ALTER TABLE [dbo].[RoleRights]
    ADD CONSTRAINT [FK_dbo_RoleFeatures_dbo_Roles_RoleId] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]);


GO
PRINT N'Creating [dbo].[FK_RoleRights_Rights]...';


GO
ALTER TABLE [dbo].[RoleRights]
    ADD CONSTRAINT [FK_RoleRights_Rights] FOREIGN KEY ([RightId]) REFERENCES [dbo].[Rights] ([RightId]);


GO
PRINT N'Creating [dbo].[FK_dbo_UserProfiles_dbo_Roles_RoleId]...';


GO
ALTER TABLE [dbo].[Users]
    ADD CONSTRAINT [FK_dbo_UserProfiles_dbo_Roles_RoleId] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]);


GO
PRINT N'Creating [dbo].[FK_Users_UserTypes]...';


GO
ALTER TABLE [dbo].[Users]
    ADD CONSTRAINT [FK_Users_UserTypes] FOREIGN KEY ([UserTypeId]) REFERENCES [dbo].[UserTypes] ([UserTypeId]);


GO
PRINT N'Creating [dbo].[FK_PurchaseDetails_MeasurementUnits]...';


GO
ALTER TABLE [dbo].[PurchaseDetails]
    ADD CONSTRAINT [FK_PurchaseDetails_MeasurementUnits] FOREIGN KEY ([MeasurementUnitId]) REFERENCES [dbo].[MeasurementUnits] ([MeasurementUnitId]);


GO
PRINT N'Creating [dbo].[FK_PurchaseDetails_Products]...';


GO
ALTER TABLE [dbo].[PurchaseDetails]
    ADD CONSTRAINT [FK_PurchaseDetails_Products] FOREIGN KEY ([ProductId]) REFERENCES [dbo].[Products] ([ProductId]);


GO
PRINT N'Creating [dbo].[FK_PurchaseDetails_Purchase]...';


GO
ALTER TABLE [dbo].[PurchaseDetails]
    ADD CONSTRAINT [FK_PurchaseDetails_Purchase] FOREIGN KEY ([PurchaseId]) REFERENCES [dbo].[Purchase] ([PurchaseId]);


GO
PRINT N'Creating [dbo].[FK_Purchase_Organizations]...';


GO
ALTER TABLE [dbo].[Purchase]
    ADD CONSTRAINT [FK_Purchase_Organizations] FOREIGN KEY ([OrganizationId]) REFERENCES [dbo].[Organizations] ([OrganizationId]);


GO
PRINT N'Creating [dbo].[FK_Purchase_Vendor]...';


GO
ALTER TABLE [dbo].[Purchase]
    ADD CONSTRAINT [FK_Purchase_Vendor] FOREIGN KEY ([VendorId]) REFERENCES [dbo].[Vendor] ([VendorId]);


GO
PRINT N'Creating [dbo].[FK_ProductVATTypes_TransactionLocalizationType]...';


GO
ALTER TABLE [dbo].[ProductVATTypes]
    ADD CONSTRAINT [FK_ProductVATTypes_TransactionLocalizationType] FOREIGN KEY ([TransactionLocalizationTypeId]) REFERENCES [dbo].[TransactionLocalizationType] ([TransactionLocalizationTypeId]);


GO
PRINT N'Creating [dbo].[FK_ProductVATTypes_TransectionTypes]...';


GO
ALTER TABLE [dbo].[ProductVATTypes]
    ADD CONSTRAINT [FK_ProductVATTypes_TransectionTypes] FOREIGN KEY ([TransactionTypeId]) REFERENCES [dbo].[TransectionTypes] ([TransectionTypeId]);


GO
PRINT N'Creating [dbo].[SpInsertPurchaseOrder]...';


GO
-- =============================================
-- Author:		Sabbir Ahmed Osmani
-- Create date: July 9, 2019
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE SpInsertPurchaseOrder
    @OrderDate DATETIME,
    @OrganizationId INT,
    @ExpectedDeleveryDate DATETIME,
    @VendorId INT,
    @VAT DECIMAL(18, 2),
    @Discount DECIMAL(18, 2),
    @IsComplete BIT,
    @PurchaseOrderDetailsJson NVARCHAR(MAX)
AS
BEGIN
    DECLARE @PurchaseOrderDetails TABLE
    (
        [ProductId] [INT] NOT NULL,
        [Iteams] [INT] NOT NULL,
        [Amount] [DECIMAL](18, 2) NOT NULL,
        [MeasurementUnitId] [INT] NOT NULL
    );
    DECLARE @NumberOfItems INT,
            @TotalAmount DECIMAL(18, 2),
            @PurchaseOrderId INT;

    INSERT INTO @PurchaseOrderDetails
    (
        ProductId,
        Iteams,
        Amount,
        MeasurementUnitId
    )
    SELECT jd.[ProductId],
           jd.[Iteams],
           jd.[Amount],
           jd.[MeasurementUnitId]
    FROM
        OPENJSON(@PurchaseOrderDetailsJson)
        WITH
        (
            [ProductId] [INT],
            [Iteams] [INT],
            [Amount] [DECIMAL](18, 2),
            [MeasurementUnitId] [INT]
        ) jd;
    SELECT @NumberOfItems = COUNT(pod.ProductId),
           @TotalAmount = SUM(pod.Amount)
    FROM @PurchaseOrderDetails pod;

    --Insert Purchase Order Information
    INSERT INTO dbo.PurchaseOrders
    (
        OrderDate,
        OrganizationId,
        Amount,
        ExpectedDeleveryDate,
        Iteams,
        VendorId,
        VAT,
        Discount,
        IsComplete
    )
    VALUES
    (   @OrderDate,            -- OrderDate - datetime
        @OrganizationId,       -- OrganizationId - int
        @TotalAmount,          -- Amount - decimal(18, 2)
        @ExpectedDeleveryDate, -- ExpectedDeleveryDate - datetime
        @NumberOfItems,        -- Iteams - int
        @VendorId,             -- VendorId - int
        @VAT,                  -- VAT - decimal(18, 2)
        @Discount,             -- Discount - decimal(18, 2)
        @IsComplete            -- IsComplete - bit
        );
    --Get PurchaseOrderId
    SET @PurchaseOrderId = SCOPE_IDENTITY();

    --Insert PurchaseOrderDetails 
    INSERT INTO dbo.PurchaseOrderDetails
    (
        ProductId,
        PurchaseOrderId,
        Iteams,
        Amount,
        MeasurementUnitId
    )
    SELECT pod.ProductId,
           @PurchaseOrderId,
           pod.Iteams,
           pod.Amount,
           pod.MeasurementUnitId
    FROM @PurchaseOrderDetails pod;
END;
GO
PRINT N'Creating Permission...';


GO
GRANT VIEW ANY COLUMN ENCRYPTION KEY DEFINITION TO PUBLIC;


GO
PRINT N'Creating Permission...';


GO
GRANT VIEW ANY COLUMN MASTER KEY DEFINITION TO PUBLIC;


GO
PRINT N'Creating Permission...';


GO
GRANT CONNECT TO [BRACITS\samnoon.mohebbo];


GO
PRINT N'Creating Permission...';


GO
GRANT CONNECT TO [BRACITS\Administrator];


GO
DECLARE @VarDecimalSupported AS BIT;

SELECT @VarDecimalSupported = 0;

IF ((ServerProperty(N'EngineEdition') = 3)
    AND (((@@microsoftversion / power(2, 24) = 9)
          AND (@@microsoftversion & 0xffff >= 3024))
         OR ((@@microsoftversion / power(2, 24) = 10)
             AND (@@microsoftversion & 0xffff >= 1600))))
    SELECT @VarDecimalSupported = 1;

IF (@VarDecimalSupported > 0)
    BEGIN
        EXECUTE sp_db_vardecimal_storage_format N'$(DatabaseName)', 'ON';
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET MULTI_USER 
    WITH ROLLBACK IMMEDIATE;


GO
PRINT N'Update complete.';


GO
